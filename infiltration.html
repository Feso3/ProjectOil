<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Tic-Tac-Toe 2: Infiltration</title>
  <style>
    :root {
      --bg: linear-gradient(135deg, #e8f0ff 0%, #fdf6ff 55%, #f4fbff 100%);
      --panel: #ffffff;
      --accent: #2f5fe8;
      --x: #1b6ef3;
      --o: #e84a5f;
      --muted: #5c667a;
      --win: #20b26b;
      --dark-cell: #3d5a80;
      --light-cell: #f0f4f8;
      --boundary: #ffd60a;
      --valid-move: #4ade80;
      --selected: #a78bfa;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg);
      color: #1d2433;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      touch-action: manipulation;
    }

    .game {
      background: var(--panel);
      padding: 24px;
      border-radius: 18px;
      box-shadow: 0 20px 40px rgba(25, 35, 57, 0.12);
      width: min(720px, 95vw);
      display: flex;
      flex-direction: column;
      gap: 14px;
      align-items: center;
    }

    h1 {
      margin: 0;
      font-size: 1.6rem;
      background: linear-gradient(135deg, var(--x) 0%, var(--o) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .phase-banner {
      width: 100%;
      padding: 12px 16px;
      border-radius: 12px;
      font-weight: 700;
      text-align: center;
      color: white;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    }

    .phase-banner.movement {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .phase-banner.pie {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      width: 100%;
    }

    .info-card {
      background: #f9fafb;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      font-size: 0.85rem;
    }

    .info-card strong {
      display: block;
      color: var(--accent);
      font-size: 0.75rem;
      text-transform: uppercase;
      margin-bottom: 4px;
      letter-spacing: 0.5px;
    }

    .inventory {
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 0.9rem;
    }

    .inventory-pieces {
      display: flex;
      gap: 2px;
    }

    .inventory-piece {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid currentColor;
    }

    .inventory.x { color: var(--x); }
    .inventory.o { color: var(--o); }

    .status {
      width: 100%;
      text-align: center;
      font-size: 0.95rem;
      color: var(--muted);
      min-height: 1.4em;
      font-weight: 600;
    }

    .board-container {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .side-label {
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .board {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      grid-template-rows: repeat(8, 1fr);
      gap: 0;
      width: 100%;
      max-width: 480px;
      aspect-ratio: 1;
      padding: 6px;
      border-radius: 14px;
      background: #2c3e50;
      box-shadow: 0 12px 24px rgba(27, 51, 106, 0.18);
      position: relative;
    }

    .board::after {
      content: '';
      position: absolute;
      left: 6px;
      right: 6px;
      top: 50%;
      height: 2px;
      background: var(--boundary);
      pointer-events: none;
      z-index: 10;
      box-shadow: 0 0 6px rgba(255, 214, 10, 0.6);
    }

    .cell {
      background: var(--light-cell);
      border: 1px solid rgba(0, 0, 0, 0.05);
      font-size: clamp(1.2rem, 3vw, 1.6rem);
      font-weight: 800;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .cell.dark {
      background: var(--dark-cell);
    }

    .cell.filled {
      animation: fadeIn 0.3s ease-out;
    }

    .cell.x { color: var(--x); text-shadow: 0 2px 6px rgba(27, 110, 243, 0.4); }
    .cell.o { color: var(--o); text-shadow: 0 2px 6px rgba(232, 74, 95, 0.4); }

    .cell.king::after {
      content: 'üëë';
      position: absolute;
      top: 2px;
      right: 2px;
      font-size: 0.5em;
    }

    .cell.valid-placement {
      box-shadow: inset 0 0 0 2px var(--valid-move);
      background: rgba(74, 222, 128, 0.1);
      cursor: pointer;
    }

    .cell.dark.valid-placement {
      background: rgba(74, 222, 128, 0.15);
    }

    .cell.valid-move {
      box-shadow: inset 0 0 0 2px var(--valid-move);
      cursor: pointer;
    }

    .cell.valid-capture {
      box-shadow: inset 0 0 0 3px #f59e0b;
      cursor: pointer;
    }

    .cell.selected {
      box-shadow: 0 0 0 3px var(--selected);
      transform: scale(1.05);
      z-index: 5;
    }

    .cell.winning {
      background: #ffd700 !important;
      box-shadow: 0 0 0 3px rgba(32, 178, 107, 0.5);
      animation: glow 1s ease-in-out infinite;
      z-index: 5;
    }

    .cell.empty:hover {
      transform: scale(1.05);
      z-index: 5;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      width: 100%;
    }

    .button {
      border: none;
      background: var(--accent);
      color: #fff;
      padding: 10px 16px;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
      min-height: 40px;
    }

    .button:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(47, 95, 232, 0.2);
    }

    .button:active {
      transform: translateY(0);
    }

    .button.secondary {
      background: #eef1fb;
      color: #1d2433;
      border: 1px solid rgba(201, 212, 229, 0.9);
    }

    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pie-decision {
      display: flex;
      gap: 8px;
      padding: 12px;
      background: #fffbeb;
      border: 2px solid #fbbf24;
      border-radius: 12px;
      width: 100%;
    }

    .pie-decision-text {
      flex: 1;
      font-size: 0.85rem;
      color: #78350f;
    }

    .config-panel {
      width: 100%;
      background: #f9fafb;
      border-radius: 12px;
      padding: 12px;
      border: 1px solid #e5e7eb;
    }

    .config-title {
      font-weight: 700;
      font-size: 0.85rem;
      margin-bottom: 8px;
      color: var(--accent);
    }

    .config-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
    }

    .config-option {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
    }

    .config-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }

    .config-option input[type="number"] {
      width: 50px;
      padding: 4px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }

    @keyframes glow {
      0%, 100% { box-shadow: 0 0 0 3px rgba(32, 178, 107, 0.5); }
      50% { box-shadow: 0 0 12px rgba(32, 178, 107, 0.8); }
    }

    @media (max-width: 640px) {
      .game { padding: 16px; }
      h1 { font-size: 1.3rem; }
      .info-grid { font-size: 0.8rem; }
      .board { max-width: 100%; }
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <main class="game" id="game">
    <h1>üéØ Tic-Tac-Toe 2: Infiltration</h1>

    <div class="phase-banner" id="phase-banner">Phase 1: Placement</div>

    <div id="pie-decision" class="pie-decision hidden">
      <div class="pie-decision-text">
        <strong>Pie Rule:</strong> O can swap colors or continue normally
      </div>
      <button class="button" id="invoke-pie">Swap</button>
      <button class="button secondary" id="decline-pie">Continue</button>
    </div>

    <div class="info-grid">
      <div class="info-card">
        <strong>Player X</strong>
        <div class="inventory x" id="inventory-x">
          <span id="count-x">8</span> pieces
        </div>
      </div>
      <div class="info-card">
        <strong>Player O</strong>
        <div class="inventory o" id="inventory-o">
          <span id="count-o">8</span> pieces
        </div>
      </div>
    </div>

    <div class="status" id="status">Player X: Place your pieces in the bottom half</div>

    <div class="board-container">
      <div class="side-label">O's Home / X's Target Zone</div>
      <div class="board" id="board"></div>
      <div class="side-label">X's Home / O's Target Zone</div>
    </div>

    <div class="controls">
      <button class="button" id="new-game">New Game</button>
      <button class="button secondary" id="toggle-config">‚öôÔ∏è Settings</button>
    </div>

    <div class="config-panel hidden" id="config-panel">
      <div class="config-title">Game Configuration</div>
      <div class="config-options">
        <div class="config-option">
          <label>Pieces: <input type="number" id="cfg-pieces" min="4" max="16" value="8"></label>
        </div>
        <div class="config-option">
          <input type="checkbox" id="cfg-capture" checked>
          <label for="cfg-capture">Capture</label>
        </div>
        <div class="config-option">
          <input type="checkbox" id="cfg-kings" checked>
          <label for="cfg-kings">Kings</label>
        </div>
        <div class="config-option">
          <input type="checkbox" id="cfg-forced-capture">
          <label for="cfg-forced-capture">Forced Capture</label>
        </div>
        <div class="config-option">
          <input type="checkbox" id="cfg-pie">
          <label for="cfg-pie">Pie Rule</label>
        </div>
      </div>
    </div>
  </main>

  <script src="infiltration-engine.js"></script>
  <script>
    // UI elements
    const gameElement = document.getElementById("game");
    const boardElement = document.getElementById("board");
    const statusElement = document.getElementById("status");
    const phaseBanner = document.getElementById("phase-banner");
    const pieDecision = document.getElementById("pie-decision");
    const invokePieBtn = document.getElementById("invoke-pie");
    const declinePieBtn = document.getElementById("decline-pie");
    const inventoryXElement = document.getElementById("inventory-x");
    const inventoryOElement = document.getElementById("inventory-o");
    const countXElement = document.getElementById("count-x");
    const countOElement = document.getElementById("count-o");
    const newGameBtn = document.getElementById("new-game");
    const toggleConfigBtn = document.getElementById("toggle-config");
    const configPanel = document.getElementById("config-panel");

    // Config inputs
    const cfgPieces = document.getElementById("cfg-pieces");
    const cfgCapture = document.getElementById("cfg-capture");
    const cfgKings = document.getElementById("cfg-kings");
    const cfgForcedCapture = document.getElementById("cfg-forced-capture");
    const cfgPie = document.getElementById("cfg-pie");

    // Game state
    let game;
    let selectedPiece = null;

    // Initialize game
    function initGame() {
      const config = {
        pieceCount: parseInt(cfgPieces.value),
        captureEnabled: cfgCapture.checked,
        kingsEnabled: cfgKings.checked,
        forcedCapture: cfgForcedCapture.checked,
        pieRule: cfgPie.checked
      };
      game = new InfiltrationEngine(config);
      selectedPiece = null;
      renderBoard();
      updateUI();
    }

    // Render the board
    function renderBoard() {
      boardElement.innerHTML = "";
      const winningIndices = new Set(game.winningLine || []);

      for (let i = 0; i < game.CELLS_COUNT; i++) {
        const cell = document.createElement("button");
        cell.type = "button";
        const coords = game.indexToCoords(i);
        const isDark = (coords.row + coords.col) % 2 === 1;
        const value = game.board[i];
        const isKing = game.isKing(i);

        let classes = ['cell'];
        if (isDark) classes.push('dark');
        if (value) {
          classes.push('filled', value.toLowerCase());
          if (isKing) classes.push('king');
        } else {
          classes.push('empty');
        }
        if (winningIndices.has(i)) classes.push('winning');
        if (selectedPiece === i) classes.push('selected');

        // Show valid placements
        if (game.phase === 'placement') {
          const validPlacements = game.getValidPlacements();
          if (validPlacements.includes(i)) {
            classes.push('valid-placement');
          }
        }

        // Show valid moves for selected piece
        if (selectedPiece !== null && game.phase === 'movement') {
          const moves = game.getValidMovesForPiece(selectedPiece);
          const move = moves.find(m => m.to === i);
          if (move) {
            if (move.type === 'capture') {
              classes.push('valid-capture');
            } else {
              classes.push('valid-move');
            }
          }
        }

        cell.className = classes.join(' ');
        cell.textContent = value;
        cell.setAttribute("data-index", i);
        cell.addEventListener("click", () => handleCellClick(i));

        boardElement.appendChild(cell);
      }
    }

    // Handle cell click
    function handleCellClick(index) {
      if (game.gameOver) return;

      if (game.phase === 'placement') {
        const result = game.placePiece(index);
        if (result.success) {
          renderBoard();
          updateUI();
        }
      } else if (game.phase === 'movement') {
        const piece = game.board[index];

        // Click on own piece to select it
        if (piece === game.currentPlayer) {
          selectedPiece = index;
          renderBoard();
          return;
        }

        // Click on empty cell or enemy to move/capture
        if (selectedPiece !== null) {
          const result = game.movePiece(selectedPiece, index);
          if (result.success) {
            selectedPiece = null;
            renderBoard();
            updateUI();
          }
        }
      }
    }

    // Update UI
    function updateUI() {
      updatePhaseBanner();
      updateInventory();
      updateStatus();
      updatePieDecision();
    }

    // Update phase banner
    function updatePhaseBanner() {
      phaseBanner.className = 'phase-banner';
      if (game.phase === 'placement') {
        phaseBanner.textContent = 'Phase 1: Placement';
      } else if (game.phase === 'movement') {
        phaseBanner.textContent = 'Phase 2: Movement & Infiltration';
        phaseBanner.classList.add('movement');
      } else if (game.phase === 'pie_decision') {
        phaseBanner.textContent = 'Pie Rule Decision';
        phaseBanner.classList.add('pie');
      }
    }

    // Update inventory display
    function updateInventory() {
      countXElement.textContent = game.inventory.X;
      countOElement.textContent = game.inventory.O;

      if (game.capturedPieces.X > 0) {
        countXElement.textContent += ` (+${game.capturedPieces.X} captured)`;
      }
      if (game.capturedPieces.O > 0) {
        countOElement.textContent += ` (+${game.capturedPieces.O} captured)`;
      }
    }

    // Update status message
    function updateStatus() {
      if (game.gameOver) {
        if (game.winner) {
          statusElement.textContent = `üéâ Player ${game.winner} wins!`;
          statusElement.style.color = game.winner === 'X' ? 'var(--x)' : 'var(--o)';
        } else {
          statusElement.textContent = "It's a draw!";
        }
      } else if (game.phase === 'placement') {
        statusElement.textContent = `Player ${game.currentPlayer}: Place your pieces in ${game.currentPlayer === 'X' ? 'bottom' : 'top'} half`;
        statusElement.style.color = 'var(--muted)';
      } else if (game.phase === 'movement') {
        if (selectedPiece !== null) {
          statusElement.textContent = `Player ${game.currentPlayer}: Select where to move`;
        } else if (game.capturedPieces[game.currentPlayer] > 0) {
          statusElement.textContent = `Player ${game.currentPlayer}: Replace captured piece or move a piece`;
        } else {
          statusElement.textContent = `Player ${game.currentPlayer}: Select a piece to move`;
        }
        statusElement.style.color = 'var(--muted)';
      }
    }

    // Update pie decision UI
    function updatePieDecision() {
      if (game.phase === 'pie_decision') {
        pieDecision.classList.remove('hidden');
      } else {
        pieDecision.classList.add('hidden');
      }
    }

    // Invoke pie rule
    invokePieBtn.addEventListener('click', () => {
      const result = game.invokePieRule();
      if (result.success) {
        renderBoard();
        updateUI();
      }
    });

    // Decline pie rule
    declinePieBtn.addEventListener('click', () => {
      const result = game.declinePieRule();
      if (result.success) {
        renderBoard();
        updateUI();
      }
    });

    // New game
    newGameBtn.addEventListener('click', () => {
      if (game && !game.gameOver) {
        if (!confirm('Start a new game? Current game will be lost.')) {
          return;
        }
      }
      initGame();
    });

    // Toggle config
    toggleConfigBtn.addEventListener('click', () => {
      configPanel.classList.toggle('hidden');
    });

    // Start game
    initGame();
  </script>
</body>
</html>
